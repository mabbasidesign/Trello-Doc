Best Practice: CI/CD + Bicep + Automatic Secrets (Azure Functions)
üéØ Goals

No secrets in code

No secrets in repo

No manual portal work

Fully automated deployments

Works with Function App + Service Bus + Key Vault

ü•á The GOLD STANDARD Architecture
GitHub / Azure DevOps
        ‚Üì
CI/CD Pipeline (Managed Identity / Service Connection)
        ‚Üì
Bicep deploys:
  - Function App
  - Service Bus
  - Key Vault
  - Managed Identity
  - RBAC assignments
        ‚Üì
App Settings reference Key Vault secrets


üëâ Secrets are never exposed to pipeline logs or code

1Ô∏è‚É£ What goes where (VERY IMPORTANT)
Item	Where
Infrastructure	Bicep
Secrets	Key Vault
References to secrets	Function App App Settings
Authentication	Managed Identity + RBAC
Deployment	CI/CD pipeline
2Ô∏è‚É£ Bicep: Create Key Vault (NO secrets yet)
resource keyVault 'Microsoft.KeyVault/vaults@2023-07-01' = {
  name: 'kv-myapp-prod'
  location: resourceGroup().location
  properties: {
    tenantId: subscription().tenantId
    sku: {
      family: 'A'
      name: 'standard'
    }
    enableRbacAuthorization: true
  }
}


‚ö†Ô∏è Use RBAC, not access policies (modern standard).

3Ô∏è‚É£ Bicep: Function App with Managed Identity
resource functionApp 'Microsoft.Web/sites@2023-01-01' = {
  name: 'func-myapp-prod'
  location: resourceGroup().location
  kind: 'functionapp'
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    siteConfig: {
      appSettings: [
        {
          name: 'ServiceBusConnection'
          value: 'mybus.servicebus.windows.net'
        }
        {
          name: 'KeyVaultUri'
          value: keyVault.properties.vaultUri
        }
      ]
    }
  }
}


No secrets here ‚Äî only resource references.

4Ô∏è‚É£ Bicep: RBAC Assignments (CRITICAL)
Function App ‚Üí Key Vault
resource kvSecretsUser 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(keyVault.id, functionApp.id, 'kv-secrets-user')
  scope: keyVault
  properties: {
    roleDefinitionId: subscriptionResourceId(
      'Microsoft.Authorization/roleDefinitions',
      '4633458b-17de-408a-b874-0445c86b69e6' // Key Vault Secrets User
    )
    principalId: functionApp.identity.principalId
  }
}

Function App ‚Üí Service Bus
resource sbReceiver 'Microsoft.Authorization/roleAssignments@2022-04-01' = {
  name: guid(serviceBus.id, functionApp.id, 'sb-receiver')
  scope: serviceBus
  properties: {
    roleDefinitionId: subscriptionResourceId(
      'Microsoft.Authorization/roleDefinitions',
      '090c5cfd-751d-490a-894a-3ce6f1109419' // Service Bus Data Receiver
    )
    principalId: functionApp.identity.principalId
  }
}

5Ô∏è‚É£ Where do secrets get created?
‚úÖ Best options (choose ONE)
ü•á Option A ‚Äî Secrets created outside pipeline (most secure)

Security team inserts secrets once

Pipeline never touches secrets

App reads secrets via Key Vault reference

ü•à Option B ‚Äî Pipeline creates secrets (acceptable)

Pipeline step:

az keyvault secret set \
  --vault-name kv-myapp-prod \
  --name ServiceBusConn \
  --value "$SERVICE_BUS_CONN"


$SERVICE_BUS_CONN comes from:

Azure DevOps secret variable

GitHub encrypted secret

‚úî Still secure
‚ùå Pipeline has access to secret

6Ô∏è‚É£ App Settings ‚Üí Key Vault Reference (Automatic)

Bicep or Pipeline sets this:

@Microsoft.KeyVault(SecretUri=https://kv-myapp-prod.vault.azure.net/secrets/ServiceBusConn)


So in Function code:

[ServiceBusTrigger("orders", Connection = "ServiceBusConn")]


Azure resolves the secret at runtime.

7Ô∏è‚É£ CI/CD Pipeline (High-level)
Azure DevOps example
steps:
- task: AzureCLI@2
  inputs:
    azureSubscription: 'azure-service-connection'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az deployment group create \
        --resource-group rg-myapp \
        --template-file main.bicep


Pipeline identity:

Service Principal

Or Managed Identity (preferred)

8Ô∏è‚É£ Deployment Order (IMPORTANT)

1Ô∏è‚É£ Deploy infrastructure (Bicep)
2Ô∏è‚É£ RBAC assignments
3Ô∏è‚É£ Create secrets (if pipeline-managed)
4Ô∏è‚É£ Deploy Function code

9Ô∏è‚É£ What interviewers LOVE to hear

Say this:

‚ÄúWe deploy infrastructure using Bicep in CI/CD, use managed identity with RBAC, store secrets in Key Vault, and reference them via app settings. The pipeline never exposes secrets.‚Äù

This is textbook enterprise Azure.

üîü What I recommend YOU do next

Given your interviews and current skill level:

üëâ Build one repo with:

Bicep folder

Function App

Service Bus

Key Vault

GitHub Actions or Azure DevOps pipeline
